---
title: 浏览器概述
date: 2025-09-19 17:02:16
permalink: /pages/de6062
categories:
  - src
  - 浏览器和网络
---
# 浏览器概述

浏览器是一个多进程的架构，我们关心的是渲染进程(核心进程)。

## 为何使用多进程架构?

由于多个线程共享着相同的地址空间和资源，所以会存在线程之间有可能会恶意修改或者获取非授权数据等复杂的安全问题。

### 单进程浏览器的问题

1. **不稳定**：单进程中的插件、渲染线程崩溃导致整个浏览器崩溃。
2. **不流畅**：脚本（死循环）或插件会使浏览器卡顿。
3. **不安全**：插件和脚本可以获取到操作系统任意资源。

### 多进程浏览器的优势

1. **解决不稳定**：进程相互隔离，一个页面或者插件崩溃时，影响仅仅是当前插件或者页面，不会影响到其他页面。
2. **解决不流畅**：脚本阻塞当前页面渲染进程，不会影响到其他页面。
3. **解决不安全**：采用多进程架构使用沙箱。沙箱可以看成是操作系统给进程上来一把锁，沙箱的程序可以运行，但不能在硬盘上写入任何数据，也不能在敏感位置读取任何数据。

## 安全沙箱

将渲染进程和OS隔离的这道墙就是安全沙箱。

**作用**：利用OS提供的安全技术，让渲染进程在执行过程中无法访问或修改OS中的数据，在渲染进程需要访问系统资源的时候，需通过浏览器内核实现，将访问结果通过IPC转发给渲染进程。

> 最小的保护单位是进程。单进程浏览器需要频繁访问或修改OS的数据，所以单进程浏览器无法被安全沙箱保护。

## 浏览器主要进程

浏览器是多进程的，主要分为以下几种：

### 1. 浏览器主进程

- 只有一个
- 控制页面的创建、销毁、网络资源管理、下载等
- 同时提供存储等功能

### 2. 第三方插件进程

- 每一种类型的插件对应一个进程
- 仅当使用该插件时才创建
- 主要负责插件的运行
- 因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响

### 3. GPU进程

- 最多一个
- 用于3D绘制等
- 从浏览器进程中独立出来的

### 4. 浏览器渲染进程(浏览器内核)

- 每个Tab页对应一个进程，互不影响
- 核心任务是将HTML、CSS和JavaScript转换为可以与用户交互的网页
- 出于安全考虑，渲染进程都是运行在沙箱模式下

### 5. 网络进程

- 从浏览器进程中独立出来的
- 主要负责页面的网络资源加载

## 浏览器渲染进程中的线程

### 1. GUI线程

- 负责渲染页面，解析html、css
- 构建DOM树和渲染树
- 当界面需要重绘(Repaint)或由于某种操作引发回流(reflow)时，该线程就会执行
- 在JavaScript引擎运行脚本期间，GUI渲染线程都是处于挂起状态的，也就是说被"冻结"了

### 2. JS引擎线程

- 负责解析和执行js程序
- 我们经常听到的Chrome的V8引擎就是跑在JS引擎线程上的
- JS引擎线程与GUI线程互斥
- 当浏览器执行JavaScript程序的时候，GUI渲染线程会保存在一个队列当中，直到js程序执行完成，才会接着执行
- 如果js的执行时间过长，会影响页面的渲染不连贯，所以我们要尽量控制js的大小

> **重要**：JS引擎线程和GUI渲染线程互斥！

### 3. 定时触发线程

- 浏览器定时计数器并不是由JS引擎计数的，因为JS引擎是单线程的，如果处于阻塞线程状态就会影响计时的准确
- 通过单独线程来计时并触发定时是更为合理的方案
- 为什么setTimeout不阻塞后面程序的运行？因为setTimeout不是由JS引擎线程完成的，是由定时器触发线程完成的，所以它们可以同时进行
- 定时器触发线程在定时任务完成之后会通知事件触发线程往任务队列里添加事件

### 4. 事件触发线程

- 当一个事件被触发时该线程会把事件添加到待处理队列的队尾，等待JS引擎的处理
- 这些事件可以是当前执行的代码块如定时任务、也可来自浏览器内核的其他线程如鼠标点击、AJAX异步请求等
- 由于JS的单线程关系，所有这些事件都得排队等待JS引擎处理

### 5. 异步HTTP请求线程

- 在XMLHttpRequest在连接后是通过浏览器新开一个线程请求
- 将检测到状态变更时，如果设置有回调函数，异步线程就产生状态变更事件放到JavaScript引擎的处理队列中等待处理

## 异步场景

常见的异步场景包括：
- 定时器
- 网络请求
- 事件绑定
- ES6 Promise

## 定时器详解

### 执行机制

1. 执行调用栈的代码
2. 栈中为空时去检查任务队列
3. 这是一个循环检查的过程
4. 等到事件触发线程往任务队列中添加了定时器事件
5. 这时再去检查已经有了定时器的异步任务，取出放进执行栈执行

### 带来的问题

- 定时任务可能不会按时执行

### 应用场景

- 防抖节流
- 倒计时
- 动画(需注意丢帧问题)

## 浏览器内核

浏览器内核是通过取得页面内容、整理信息、计算和组合最终输出可视化图像结果（渲染引擎）。

> 每一个tab页面可以看作是浏览器内核进程，浏览器内核是多线程的。

### 常见浏览器内核

| 内核名称 | 代表浏览器 |
|---------|----------|
| Trident | IE，360，搜狗等浏览器 |
| Gecko | Netscape6及以上版本，Firefox |
| Blink | Opera7及以上 |
| Webkit | Safari，Chrome |

## 浏览器版本检测

### 1. User-Agent检测

检测`window.navigator.userAgent`的值，但这种方式很不可靠，因为userAgent可以被改写，并且早期的浏览器如IE，会通过伪装自己的userAgent的值为Mozilla来躲过服务器的检测。

### 2. 功能检测

根据每个浏览器独有的特性来进行判断，如IE下独有的`ActiveXObject`。